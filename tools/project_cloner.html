<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniDjango é¡¹ç›®å…‹éš†å·¥å…·</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .hint { font-size: 12px; color: #888; margin-top: 4px; }
        button { background-color: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #45a049; }
        textarea { width: 100%; height: 300px; margin-top: 20px; font-family: 'Consolas', 'Monaco', monospace; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #1e1e1e; color: #d4d4d4; }
        .step { background-color: #e8f5e9; padding: 15px; border-left: 4px solid #4CAF50; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ UniDjango é¡¹ç›®å…‹éš†å™¨</h1>
        
        <div class="step">
            <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
            <ol>
                <li>å¡«å†™ä¸‹æ–¹çš„æ–°é¡¹ç›®ä¿¡æ¯ã€‚</li>
                <li>ç‚¹å‡»â€œç”Ÿæˆè„šæœ¬â€ã€‚</li>
                <li>å¤åˆ¶ç”Ÿæˆçš„ PowerShell è„šæœ¬ã€‚</li>
                <li style="color: red; font-weight: bold;">æ³¨æ„ï¼šè¯·åœ¨ PowerShell çª—å£ä¸­è¿è¡Œï¼ˆæŒ‰ Win+X é€‰æ‹© Windows PowerShellï¼‰ï¼Œä¸è¦åœ¨ CMD å‘½ä»¤è¡Œä¸­è¿è¡Œï¼</li>
            </ol>
        </div>

        <div class="form-group">
            <label>æ¨¡æ¿é¡¹ç›®è·¯å¾„ (å³ UniDjango æ‰€åœ¨ä½ç½®)</label>
            <input type="text" id="sourcePath" value="D:\UniDjango" placeholder="ä¾‹å¦‚ D:\UniDjango">
            <div class="hint">æˆ‘ä»¬è¦å¤åˆ¶å“ªä¸ªé¡¹ç›®ä½œä¸ºæ¨¡æ¿ï¼Ÿ</div>
        </div>

        <div class="form-group">
            <label>æ–°é¡¹ç›®å°†å­˜æ”¾åœ¨å“ªé‡Œ (çˆ¶ç›®å½•)</label>
            <input type="text" id="destFolder" value="D:\ylf-projects" placeholder="ä¾‹å¦‚ D:\ylf-projects">
            <div class="hint">è„šæœ¬ä¼šè‡ªåŠ¨åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶å¤¹</div>
        </div>

        <div class="form-group">
            <label>æ–°é¡¹ç›®åç§° (New Name)</label>
            <input type="text" id="newName" placeholder="ä¾‹å¦‚ MyNewProject">
            <div class="hint">å°†ä½œä¸ºæ–‡ä»¶å¤¹åå’Œå®¹å™¨å‰ç¼€ (å¦‚ mynewproject-django)</div>
        </div>

        <div class="form-group">
            <label>æ–°åç«¯ç«¯å£ (Django Port)</label>
            <input type="number" id="djangoPort" value="8001">
            <div class="hint">æ—§é¡¹ç›®æ˜¯ 8000</div>
        </div>

        <div class="form-group">
            <label>æ–°å‰ç«¯ç«¯å£ (Vue Port)</label>
            <input type="number" id="vuePort" value="9529">
            <div class="hint">æ—§é¡¹ç›®æ˜¯ 9528</div>
        </div>

        <div class="form-group">
            <label>æ–°æ•°æ®åº“ç«¯å£ (MySQL Port)</label>
            <input type="number" id="mysqlPort" value="3309">
            <div class="hint">æ—§é¡¹ç›®æ˜¯ 3308</div>
        </div>

        <button onclick="generateScript()">ç”Ÿæˆ PowerShell è„šæœ¬</button>

        <textarea id="output" readonly placeholder="è„šæœ¬å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        <button onclick="copyToClipboard()" style="background-color: #2196F3; margin-top: 10px;">å¤åˆ¶è„šæœ¬</button>
    </div>

    <script>
        function generateScript() {
            try {
                // Get values
                const sourceInput = document.getElementById('sourcePath');
                const destInput = document.getElementById('destFolder');
                const nameInput = document.getElementById('newName');
                
                if (!sourceInput || !destInput || !nameInput) {
                    alert("é¡µé¢å…ƒç´ åŠ è½½é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼");
                    return;
                }

                const sourceRaw = sourceInput.value.trim();
                const destFolderRaw = destInput.value.trim();
                const name = nameInput.value.trim();
                
                const djangoPort = document.getElementById('djangoPort').value.trim();
                const vuePort = document.getElementById('vuePort').value.trim();
                const mysqlPort = document.getElementById('mysqlPort').value.trim();

                if (!name) {
                    alert("è¯·è¾“å…¥æ–°é¡¹ç›®åç§°ï¼");
                    return;
                }
                if (!destFolderRaw) {
                    alert("è¯·è¾“å…¥ç›®æ ‡å­˜æ”¾ç›®å½•ï¼");
                    return;
                }

                const prefix = name.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                // Construct paths safely. We rely on PowerShell to handle paths, so we just need valid strings.
                // PowerShell handles "C:\Path" correctly.
                const newPathRaw = destFolderRaw.replace(/\\$/, '') + '\\' + name;

                const script = `# PowerShell Script to Clone UniDjango Project
$ErrorActionPreference = "Stop"

$SourcePath = '${sourceRaw}'
$NewPath = '${newPathRaw}'
$Prefix = '${prefix}'
$DjangoPort = "${djangoPort}"
$VuePort = "${vuePort}"
$MysqlPort = "${mysqlPort}"

Write-Host "1. Copying project files..." -ForegroundColor Cyan
if (Test-Path $NewPath) {
    Write-Error "Destination path already exists: $NewPath"
}
# Use Robocopy with exclusions for speed and efficiency
# /E = copy subdirectories
# /MT:8 = multi-threaded copy (faster)
# /XD = exclude directories (prevents copying heavy/unwanted folders)
# We remove /NFL /NDL so you can see the file copy progress
robocopy $SourcePath $NewPath /E /MT:8 /XD node_modules .git dist db_data __pycache__ .idea
if ($LASTEXITCODE -ge 8) { Write-Error "Robocopy failed with exit code $LASTEXITCODE" }

Write-Host "2. Configuration files..." -ForegroundColor Cyan
# (Cleanup step is no longer needed as we excluded the files during copy)

# Function to replace text in file
function Replace-InFile {
    param ($Path, $Old, $New)
    if (Test-Path $Path) {
        (Get-Content $Path) -replace [regex]::Escape($Old), $New | Set-Content $Path
    } else {
        Write-Warning "File not found: $Path"
    }
}

# 3.1 Update docker-compose.yml
$ComposePath = "$NewPath\\docker-compose.yml"
Replace-InFile -Path $ComposePath -Old "container_name: ylf-" -New "container_name: $Prefix-"
Replace-InFile -Path $ComposePath -Old "ylf-network" -New "$Prefix-network"
Replace-InFile -Path $ComposePath -Old "8000:8000" -New "$DjangoPort:8000"
Replace-InFile -Path $ComposePath -Old "3308:3306" -New "$MysqlPort:3306"

# 3.2 Update docker-compose-dev.yml
$DevComposePath = "$NewPath\\docker-compose-dev.yml"
Replace-InFile -Path $DevComposePath -Old "9528:9528" -New "$VuePort:9528"
Replace-InFile -Path $DevComposePath -Old "ylf-network" -New "$Prefix-network"
Replace-InFile -Path $DevComposePath -Old "image: ylf-vue:dev" -New "image: $Prefix-vue:dev"

# 3.3 Update settings.py
$SettingsPath = "$NewPath\\UniDjango\\UniDjango\\settings.py"
# Update DB Host fallback if necessary, though docker-compose env var usually handles it.

# 3.4 Update vue.config.js
$VueConfigPath = "$NewPath\\frontend\\vue.config.js"
Replace-InFile -Path $VueConfigPath -Old "port = 9528" -New "port = $VuePort"
Replace-InFile -Path $VueConfigPath -Old "|| 9528" -New "|| $VuePort"

# 3.5 Update request.js
$RequestPath = "$NewPath\\frontend\\src\\utils\\request.js"
Replace-InFile -Path $RequestPath -Old "localhost:8000" -New "localhost:$DjangoPort"

Write-Host "âœ… Done! New project created at: $NewPath" -ForegroundColor Green
Write-Host "To start it:"
Write-Host "  cd $NewPath"
Write-Host "  docker-compose -f docker-compose.yml -f docker-compose-dev.yml up -d --build"
`;
                document.getElementById('output').value = script;
            } catch (e) {
                alert("ç”Ÿæˆè„šæœ¬æ—¶å‡ºé”™: " + e.message);
                console.error(e);
            }
        }

        function copyToClipboard() {
            const copyText = document.getElementById("output");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("è„šæœ¬å·²å¤åˆ¶ï¼è¯·åœ¨ PowerShell ä¸­ç²˜è´´è¿è¡Œã€‚");
        }
    </script>
</body>
</html>